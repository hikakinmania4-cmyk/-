<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🥺ぷゆゆな集会場🥺</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  :root{--primary:#1565c0;--accent:#0288d1;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--danger:#ef4444;--text-main:#111827;--text-muted:#6b7280;--border-color:#e5e7eb;}
  .dark-mode{--primary:#60a5fa;--accent:#38bdf8;--bg:#111827;--card:#1f2937;--muted:#9ca3af;--text-main:#f9fafb;--text-muted:#9ca3af;--border-color:#374151;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:var(--bg);margin:0;padding:0;color:var(--text-main);transition:background-color .3s,color .3s;}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  header h1{margin:0;font-size:18px;flex-grow:1;word-break:break-all;}
  header .controls{display:flex;gap:8px;align-items:center;}
  header .userbox{font-size:13px; margin-left: auto; text-align:right;}
  header button{background:rgba(255,255,255,0.14);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  header button:hover{background:rgba(255,255,255,0.22)}
  .wrap{max-width:1000px;margin:16px auto;padding:12px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(2,6,23,0.06);margin-bottom:12px;border:1px solid var(--border-color); transition: background-color .3s, border-color .3s;}
  .card h2{margin:0 0 8px 0;font-size:16px;color:var(--primary);word-break:break-all;}
  .thread-header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:flex-start;gap:8px;}
  .thread-header-main{min-width:60%;flex-grow:1;}
  .thread-header-meta{text-align:right;flex-shrink:0;margin-left:auto;}
  input[type="text"],textarea,select{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;background:var(--card);color:var(--text-main);}
  textarea{min-height:80px;resize:vertical}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background-color 0.2s;}
  .btn:disabled{background:var(--muted);cursor:not-allowed;}
  .btn.warn{background:var(--danger)}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
  .btn.liked{background:#e11d48;color:white;}
  .search-box{display:flex;gap:8px;margin-bottom:12px;}
  .thread-item, .history-item{padding:10px;border-radius:8px;border:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;gap:12px; margin-bottom: 8px;}
  .thread-link{font-weight:600;color:var(--primary);text-decoration:none; display:block;}
  .thread-info{flex-grow:1; display:flex; align-items:center; gap: 8px; min-width:0;}
  .thread-title-wrapper{min-width:0;}
  .thread-preview-img{width:60px;height:60px;object-fit:cover;border-radius:6px;margin-left:12px;flex-shrink:0;}
  .meta{font-size:13px;color:var(--text-muted)}
  .post{padding:10px;border-top:1px solid var(--border-color);margin-top:8px;}
  #postsContainer > .post:first-child{margin-top:0;}
  .post .meta{font-size:12px;color:var(--text-muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-bottom: 8px;}
  .post .meta .no{color:var(--accent);cursor:pointer;font-weight:700}
  .post .meta .post-author{font-weight:bold;cursor:pointer; color: var(--text-main);}
  .post .body{white-space:pre-wrap;word-break:break-word}
  .post .body a{color:var(--primary);}
  .post img{max-width:280px;height:auto;border-radius:6px;margin-top:8px;display:block;cursor:pointer}
  .controls{margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .badge-op, .badge-level{background:var(--primary);color:white;padding:3px 6px;border-radius:999px;font-size:12px; white-space:nowrap;}
  .badge-new{background:var(--danger);color:white;padding:3px 6px;border-radius:999px;font-size:10px;font-weight:bold;}
  .banned-note, .deleted-note{color:var(--danger);font-weight:700;margin-top:8px;}
  .small-muted{font-size:12px;color:var(--text-muted)}
  .modal-overlay,.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-content{background:var(--bg);border-radius:10px;width:90%;max-width:600px;max-height:80%;display:flex;flex-direction:column;border:1px solid var(--border-color);}
  .modal-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;}
  .modal-header h2{font-size:18px;color:var(--primary);margin:0;}
  .modal-close-btn,.lightbox-close-btn{font-size:28px;background:none;border:none;cursor:pointer;color:white;position:absolute;top:10px;right:15px;}
  .modal-close-btn{color:var(--text-muted);position:static;}
  .modal-body{padding:16px;overflow-y:auto;}
  #profileId{color:var(--text-muted);font-size:13px;margin:0 0 12px 0;word-break:break-all;}
  #profileControls{margin-bottom:12px; border-top:1px solid var(--border-color); padding-top:12px; display:flex; gap:8px;}
  .lightbox-content img{max-width:90vw;max-height:90vh;display:block;}
  .vote-box .btn.liked { background: var(--primary); }
  @media(max-width:680px){header{justify-content:center;}header .userbox{width:100%;text-align:center;margin:4px 0;}}
</style>
</head>
<body>
  <header>
    <h1>🥺ぷゆゆな集会場🥺</h1>
    <div class="userbox"><span id="userDisplay"></span> <button id="changeNameBtn" class="small">名前変更</button></div>
    <div class="controls"><button id="homeBtn">🏠 ホーム</button><button id="historyBtn">📜 履歴</button><button id="themeToggleBtn">🌙</button><button id="refreshBtn">🔄 更新</button></div>
  </header>
  <div class="wrap" id="app"></div>
  <div id="profileModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="profileName"></h2><button id="closeProfileBtn" class="modal-close-btn">&times;</button></div><div class="modal-body"><p id="profileId"></p><div id="profileControls"></div><h3>この人の投稿</h3><div id="profilePostsList"></div></div></div></div>
  <div id="imageLightbox" class="lightbox-overlay"><div class="lightbox-content"><img id="lightboxImage" src=""><button id="lightboxClose" class="lightbox-close-btn">&times;</button></div></div>
  <div id="voteModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>アンケート作成</h2><button id="closeVoteModalBtn" class="modal-close-btn">&times;</button></div><div class="modal-body"><h4>選択肢</h4><div id="voteOptionsContainer"><input type="text" class="vote-option-input" placeholder="選択肢1" style="margin-bottom:8px;"><input type="text" class="vote-option-input" placeholder="選択肢2" style="margin-bottom:8px;"></div><button id="addVoteOptionBtn" class="btn small">選択肢を追加</button><div style="text-align:right; margin-top:16px;"><button id="insertVoteBtn" class="btn">本文に挿入</button></div></div></div></div>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyDS3Tlr9Oc4z5Kz2Zg72p9VRayPSAbmwTw",
  authDomain: "config-f5509.firebaseapp.com",
  databaseURL: "https://config-f5509-default-rtdb.firebaseio.com",
  projectId: "config-f5509",
  storageBucket: "config-f5509.appspot.com",
  messagingSenderId: "513023904601",
  appId: "1:513023904601:web:1846aa87aec5de306e1a48",
  measurementId: "G-KT2LZC2EED"
};
const NG_WORDS = ['바보', '멍청이', '죽어', '死ね', 'バカ', '馬鹿', 'kill', 'idiot'];
const ADMIN_IDS = ['W4ZZKXRY9CS'];
document.addEventListener('DOMContentLoaded', () => { main(); });
function main() {
  if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
    document.getElementById('app').innerHTML = `<div class="card"><h2>🚨 設定が必要です！</h2><p>HTMLファイル内の <code>firebaseConfig</code> が未設定です。</p></div>`; return;
  }
  try { firebase.initializeApp(firebaseConfig); } catch (e) { alert("Firebaseの初期化に失敗しました。"); return; }
  const db = firebase.database();
  let activeDataListener = null, activeViewersListener = null, myConnectionRef = null, allThreads = [];
  function cleanupListeners() {
    if(activeDataListener){ activeDataListener.ref.off('value', activeDataListener.callback); activeDataListener = null; }
    if(activeViewersListener){ activeViewersListener.ref.off('value', activeViewersListener.callback); activeViewersListener = null; }
    if(myConnectionRef){ myConnectionRef.remove(); myConnectionRef = null; }
  }
  const PERMANENT_ID_COOKIE = 'puyuyun_permanent_id_v2';
  const DAILY_ID_COOKIE = 'puyuyun_daily_id_v2';
  const USERNAME_COOKIE = 'puyuyun_username_v1';
  const MAX_IMAGE_BYTES = 10 * 1024 * 1024;
  const POST_LIMIT = 1000;
  const HISTORY_KEY = 'puyuyun_history_v1';
  const THEME_KEY = 'puyuyun_theme';
  const LEVEL_THRESHOLDS = { 1: 0, 5: 10, 10: 30, 20: 60 };
  const LEVEL_TITLES = { 1: 'ぷゆゆなキッズ', 5: 'ぷゆゆな初心者', 10: 'ぷゆゆな常連', 20: 'ぷゆゆ本人'};
  const REACTION_PAIRS = { '🥺': '🥹', '😎': '🤓', '😅': '😓' };
  const BASE_REACTIONS = Object.keys(REACTION_PAIRS);
  
  function uid(l=10){return Math.random().toString(36).slice(2,2+l).toUpperCase();}
  function setCookie(n,v,d=365){const e=new Date();e.setTime(e.getTime()+(d*24*60*60*1000));document.cookie=`${n}=${encodeURIComponent(v)};expires=${e.toUTCString()};path=/;SameSite=Lax`;}
  function getCookie(n){const kv=document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(n+'='));return kv?decodeURIComponent(kv.split('=')[1]):null;}
  function escapeHTML(s){if(s==null)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
  function formatTimestamp(ts) {
    const d = new Date(ts);
    const M = (d.getMonth() + 1).toString().padStart(2, '0');
    const D = d.getDate().toString().padStart(2, '0');
    const h = d.getHours().toString().padStart(2, '0');
    const m = d.getMinutes().toString().padStart(2, '0');
    return `${M}/${D} ${h}:${m}`;
  }
  function renderContent(s, post = null) {
    let escaped = escapeHTML(s);
    if(escaped.match(/javascript:/i)) return '[XSS Alert]';
    const withAnkas = escaped.replace(/&gt;&gt;(\d+)/g, '<a href="#" data-link="$1">&gt;&gt;$1</a>');
    const urlRegex = /(https?:\/\/[^\s<>"'()]+)/g;
    const withUrls = withAnkas.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    let voteIndex = 0;
    const withVotes = withUrls.replace(/\[vote:([^\]]+)\]/g, (match, p1) => {
      const voteId = post ? `vote-${post.id}-${voteIndex++}` : `vote-preview-${voteIndex++}`;
      const options = p1.split(',').map(opt => opt.trim());
      return `<div class="vote-box" id="${voteId}">${options.map(opt => `<button class="btn small vote-btn" data-vote-option="${escapeHTML(opt)}">${escapeHTML(opt)}</button>`).join(' ')}</div>`;
    });
    return withVotes.replace(/\n/g, '<br>');
  }
  
  function ensureUser() {
    let permanentId = getCookie(PERMANENT_ID_COOKIE);
    if (!permanentId) {
      const oldId = getCookie('puyuyun_permanent_id_v1');
      if (oldId) {
        permanentId = oldId;
        setCookie(PERMANENT_ID_COOKIE, permanentId, 365 * 10);
      } else {
        permanentId = uid(16);
        setCookie(PERMANENT_ID_COOKIE, permanentId, 365 * 10);
      }
    }
    const todayStr = new Date().toISOString().slice(0, 10);
    let dailyInfo = {}; try { dailyInfo = JSON.parse(getCookie(DAILY_ID_COOKIE) || '{}'); } catch (e) {}
    if (dailyInfo.date !== todayStr || !dailyInfo.id) { dailyInfo = { id: uid(8), date: todayStr }; setCookie(DAILY_ID_COOKIE, JSON.stringify(dailyInfo), 1); }
    let username = getCookie(USERNAME_COOKIE) || '名無し' + Math.floor(Math.random()*900+100);
    return { permanentId, id: dailyInfo.id, name: username };
  }
  
  function getLevel(exp) {
    let userLevel = 1, userTitle = 'ぷゆゆなキッズ';
    const sortedLevels = Object.keys(LEVEL_THRESHOLDS).sort((a,b) => parseInt(a) - parseInt(b));
    for(const lv of sortedLevels){ if(exp >= LEVEL_THRESHOLDS[lv]){ userLevel = lv; userTitle = LEVEL_TITLES[lv]; }}
    return { level: userLevel, title: userTitle };
  }
  function setUserName(n){setCookie(USERNAME_COOKIE, n, 365);refreshHeader();}
  function getUser(){return ensureUser();}
  function refreshHeader(){document.getElementById('userDisplay').textContent=`あなた: ${getUser().name}`;}
  function loadHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[];}catch(e){return[];}}
  function saveHistory(h){localStorage.setItem(HISTORY_KEY,JSON.stringify(h));}
  function addToHistory(id,title,lastUpdatedAt){let h=loadHistory();h=h.filter(i=>i.id!==id);h.unshift({id,title,lastUpdatedAt,visitedAt:Date.now()});if(h.length>50)h.pop();saveHistory(h);}
  function removeFromHistory(id){let h=loadHistory();h=h.filter(i=>i.id!==id);saveHistory(h);}
  function goHome(){location.hash='';}
  window.addEventListener('hashchange', renderApp);

  function displayThreads(threadsToDisplay) {
    const c = document.getElementById('threadListContainer'); if(!c) return;
    const history = loadHistory();
    if(threadsToDisplay.length===0){c.innerHTML=`<div class="small-muted">該当するスレッドがありません</div>`;}
    else{c.innerHTML='';threadsToDisplay.forEach(t=>{
      const firstPost = (t.posts && Object.keys(t.posts).length > 0) ? Object.values(t.posts).sort((a,b)=>a.createdAt-b.createdAt)[0] : null;
      const imgHtml = firstPost && firstPost.img ? `<img src="${firstPost.img}" class="thread-preview-img" alt="preview">` : '';
      const historyItem = history.find(h => h.id === t.id);
      const newBadge = historyItem && t.lastUpdatedAt > historyItem.visitedAt ? `<span class="badge-new">New!</span>` : '';
      const i=document.createElement('div');i.className='thread-item';
      i.innerHTML=`<div class="thread-info"><div class="thread-title-wrapper"><a class="thread-link" href="#thread-${t.id}">${escapeHTML(t.title)}</a></div>${newBadge}</div><div class="meta" style="flex-shrink:0;">(${(t.posts?Object.keys(t.posts).length:0)}レス)</div>${imgHtml}`;
      c.appendChild(i);
    });}
  }

  function renderHome() {
    try {
      document.getElementById('app').innerHTML = `<div class="card"><h2>新しいスレッドを作成</h2><input id="newTitle" type="text" placeholder="タイトル" style="margin-bottom:8px;"><input id="newName" type="text" placeholder="名前（任意）" value="${escapeHTML(getUser().name)}" style="margin-bottom:8px;"><textarea id="newText" placeholder="本文 (必須)"></textarea><button id="createVoteBtn" class="btn small" style="margin-top:8px;">アンケート作成</button><div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;"><input id="newImage" type="file" accept="image/*"><button class="btn" id="createThreadBtn">スレ作成</button></div></div><div class="card"><h2>スレッド一覧</h2><div class="search-box"><input type="text" id="searchInput" placeholder="スレッドタイトルを検索"><button id="searchBtn" class="btn small">検索</button><button id="clearSearchBtn" class="btn small">クリア</button></div><div id="threadListContainer">読み込み中...</div></div>`;
      const ref = db.ref('threads').orderByChild('lastUpdatedAt');
      const cb = ref.on('value', s => {
        allThreads = Object.values(s.val()||{}).sort((a,b)=>b.lastUpdatedAt-a.lastUpdatedAt);
        displayThreads(allThreads);
      }, e => { console.error(e); document.getElementById('threadListContainer').innerHTML = '<div class="banned-note">スレッドの読み込みに失敗しました。</div>'; });
      activeDataListener = { ref, callback: cb };
      document.getElementById('searchBtn').onclick=()=>{const t=document.getElementById('searchInput').value.toLowerCase();if(!t)return;displayThreads(allThreads.filter(th=>th.title.toLowerCase().includes(t)));};
      document.getElementById('clearSearchBtn').onclick=()=>{document.getElementById('searchInput').value='';displayThreads(allThreads);};
      document.getElementById('searchInput').onkeydown=(e)=>{if(e.key==='Enter')document.getElementById('searchBtn').click();};
      document.getElementById('createThreadBtn').onclick=async()=>{const b=document.getElementById('createThreadBtn');b.disabled=true;b.textContent='作成中...';try{const t=document.getElementById('newTitle').value.trim(),n=document.getElementById('newName').value.trim(),x=document.getElementById('newText').value.trim(),f=document.getElementById('newImage').files[0];if(!t||!x)throw new Error('タイトルと本文は必須です');if(containsNGWord(t)||containsNGWord(x)||containsNGWord(n))throw new Error('不適切な単語が含まれています。');const u=getUser();if(n&&n!==u.name){setUserName(n);}const i=f?await readFileAsDataURL(f):null;const r=db.ref('threads').push();const d=r.key;const pK=r.key;await r.set({id:d,title:t,createdAt:Date.now(),lastUpdatedAt:Date.now(),op:getUser(),posts:{[pK]:{id:pK,author:getUser(),text:x,img:i,createdAt:Date.now()}},postCounter:1});location.hash='thread-'+d;}catch(e){alert('エラー: '+e.message);b.disabled=false;b.textContent='スレ作成';}};
      setupVoteModal('newText');
    } catch(e) {
      console.error("ホームページの描画に失敗:", e);
      document.getElementById('app').innerHTML = `<div class="card"><div class="banned-note">ページの読み込みに失敗しました。</div></div>`;
    }
  }
  
  function renderHistoryPage() {
    let content = '<h2>📜 閲覧履歴</h2>';
    try {
        const history = loadHistory();
        if(history.length === 0) { content += '<div class="small-muted">まだ閲覧履歴がありません。</div>'; }
        else { history.forEach(item => {
            const historyItem = allThreads.find(t => t.id === item.id);
            if (!historyItem) return; 
            let firstPost = null;
            if (historyItem.posts && Object.keys(historyItem.posts).length > 0) {
                firstPost = Object.values(historyItem.posts).sort((a, b) => a.createdAt - b.createdAt)[0];
            }
            const imgHtml = firstPost && firstPost.img ? `<img src="${firstPost.img}" class="thread-preview-img" alt="preview">` : '';
            const newBadge = historyItem.lastUpdatedAt > item.visitedAt ? `<span class="badge-new">New!</span>` : '';
            content += `<div class="history-item"><div class="thread-info"><a class="thread-link" href="#thread-${item.id}">${escapeHTML(item.title)}</a>${newBadge}</div><div style="text-align:right;"><div class="small-muted">${formatTimestamp(item.visitedAt)}</div></div>${imgHtml}</div>`;
        });}
    } catch (e) {
        console.error("閲覧履歴の描画に失敗:", e);
        content += '<div class="banned-note">履歴の表示中にエラーが発生しました。</div>';
    }
    document.getElementById('app').innerHTML = `<div class="card">${content}</div>`;
  }
    async function renderThread(id) {
    document.getElementById('app').innerHTML=`<div class="card">読み込み中...</div>`;
    try {
      const userLevels=(await db.ref('userLevels').once('value')).val()||{};
      const globalBanList=(await db.ref('globalBan').once('value')).val()||{};
      const ref=db.ref('threads/'+id);
      const cb=ref.on('value',s=>{
        if(!document.getElementById('app'))return;const t=s.val();if(!t){removeFromHistory(id);goHome();return;}
        const p=Object.values(t.posts||{}).sort((a,b)=>a.createdAt-b.createdAt);
        addToHistory(t.id,t.title,t.lastUpdatedAt);
        const u=getUser(),o=t.op&&t.op.permanentId===u.permanentId,isAdm=ADMIN_IDS.includes(u.permanentId);
        const pC=p.length;
        let rF=(pC>=POST_LIMIT)?`<div class="banned-note" style="text-align:center;padding:10px;">このスレッドは${POST_LIMIT}レスに達しました。</div>`:`<h4>レス投稿</h4><input id="replyName" type="text" placeholder="名前" value="${escapeHTML(u.name)}" style="margin-bottom:8px;"><small class="small-muted" style="display:block;margin-top:-6px;margin-bottom:8px;">名前欄に sage と入力するとスレッドがトップに上がらなくなります。</small><textarea id="replyText" placeholder="本文"></textarea><button id="createVoteBtn" class="btn small" style="margin-top:8px;">アンケート作成</button><div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;"><input id="replyImage" type="file" accept="image/*"><button class="btn" id="replyBtn">投稿</button></div>`;
        let pH='';p.forEach((post,idx)=>{const exp=userLevels[post.author.permanentId]?.exp||0;const l=getLevel(exp);const b=t.banned&&t.banned[post.author.permanentId],gb=globalBanList[post.author.permanentId],reacs=post.reactions||{},mR=reacs[u.permanentId];let aH=`<b class="post-author" onclick="window.showUserProfile('${escapeHTML(post.author.name).replace(/'/g,"\\'")}', '${post.author.permanentId}', ${o||isAdm})">${escapeHTML(post.author.name)}</b> <span class="badge-level">${l.title}</span>`;if(post.author.permanentId===t.op.permanentId)aH+=` <span class="badge-op">スレ主</span>`;const rC={};BASE_REACTIONS.forEach(r=>rC[r]=0);Object.values(reacs).forEach(reac=>{if(rC[reac]!==undefined)rC[reac]++;});let ctlH=BASE_REACTIONS.map(bR=>{const count=rC[bR];const iMR=mR===bR;const dR=iMR?REACTION_PAIRS[bR]:bR;return`<button class="btn small ${iMR?'liked':''}" onclick="window.react('${id}','${post.id}','${bR}')">${dR} ${count}</button>`;}).join(' ');if(u.permanentId===post.author.permanentId||o||isAdm)ctlH+=` <button class="btn small warn" onclick="window.deletePost('${id}','${post.id}')">削除</button>`;if(u.permanentId===post.author.permanentId)ctlH+=` <button class="btn small" onclick="window.editPost('${id}','${post.id}')">編集</button>`;const pB=post.deleted?`<div class="deleted-note">[削除されました]</div>`:`<div class="body">${renderContent(post.text,post)}</div>${post.img?`<img src="${post.img}" onclick="window.openLightbox(this.src)">`:''}`;pH+=`<div class="post" id="post-${idx+1}" data-post-id="${post.id}"><div class="meta"><span class="no" onclick="window.quote(${idx+1})">No.${idx+1}</span>${aH}<span class="small-muted" style="margin-left:auto">${formatTimestamp(post.createdAt)}</span></div>${b||gb?`<div class="banned-note">${gb?'[このユーザーはBANされています]':'[このユーザーはこのスレでアク禁されています]'}</div>`:`${pB}<div class="controls">${ctlH}</div>`}</div>`;});
        document.getElementById('app').innerHTML=`<div class="card"><div class="thread-header"><div class="thread-header-main"><h2>${escapeHTML(t.title)}</h2></div><div class="thread-header-meta">${o||isAdm?`<button class="btn small warn" onclick="window.deleteThread('${id}')">スレを削除</button>`:''}<div class="small-muted">作成: ${formatTimestamp(t.createdAt)}</div><div class="small-muted" style="margin-top:4px;">閲覧中: <span id="viewer-count">...</span>人</div></div></div></div><div class="card" id="postsContainer">${pH}</div><div class="card">${rF}</div>`;
        document.querySelectorAll('a[data-link]').forEach(a=>{a.onclick=e=>{e.preventDefault();const target = document.getElementById(`post-${a.dataset.link}`); if (target) target.scrollIntoView({behavior:'smooth',block:'center'});};});
        if(pC<POST_LIMIT){document.getElementById('replyBtn').onclick=()=>postReply(id);setupVoteModal('replyText');}
        document.querySelectorAll('.post').forEach((pE,idx)=>{const pD=p[idx];if(!pD||!pD.votes) return; pE.querySelectorAll('.vote-box').forEach(vB=>{const vI=vB.id;const vD=pD.votes[vI];if(!vD)return;const res={};const oE=vB.querySelectorAll('.vote-btn');const opts=Array.from(oE).map(e=>e.dataset.voteOption);opts.forEach(o=>res[o]=0);const total=Object.values(vD).length;Object.values(vD).forEach(vO=>{if(res[vO]!==undefined)res[vO]++;});let resH='<div class="vote-results" style="font-size:12px; margin-top:8px;">';opts.forEach(o=>{const count=res[o];const pct=total>0?((count/total)*100).toFixed(1):0;resH+=`<div>${escapeHTML(o)}: ${count}票 (${pct}%)</div><div style="background:#e5e7eb;border-radius:4px;height:8px;width:100%;margin:2px 0 6px;"><div style="background:var(--primary);height:100%;width:${pct}%;border-radius:4px;"></div></div>`;});resH+='</div>';const exR=vB.querySelector('.vote-results');if(exR)exR.remove();vB.insertAdjacentHTML('beforeend',resH);const myV=vD[getUser().permanentId];if(myV){oE.forEach(b=>{b.disabled=true;if(b.dataset.voteOption===myV)b.classList.add('liked');});}});});
        document.querySelectorAll('.vote-btn:not([disabled])').forEach(b=>{b.onclick=()=>{const vB=b.closest('.vote-box');vB.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true); const pE=b.closest('.post');const pI=pE.dataset.postId;const opt=b.dataset.voteOption;window.castVote(id,pI,vB.id,opt);};});
      },e=>{console.error(e); document.getElementById('app').innerHTML = `<div class="card"><div class="banned-note">スレッドの読み込みに失敗しました。</div></div>`;});
      activeDataListener={ref,callback:cb};const vRef=db.ref('viewers/'+id);myConnectionRef=vRef.push(true);myConnectionRef.onDisconnect().remove();const vCb=vRef.on('value',s=>{const e=document.getElementById('viewer-count');if(e)e.textContent=s.numChildren();});activeViewersListener={ref:vRef,callback:vCb};
    } catch(e) {
      console.error("スレッド描画の致命的エラー:", e);
      document.getElementById('app').innerHTML = `<div class="card"><div class="banned-note">ページの表示中に予期せぬエラーが発生しました。</div></div>`;
    }
  }

  async function postReply(id) {
    const b=document.getElementById('replyBtn');b.disabled=true;try{const u=getUser();const iGB=(await db.ref(`globalBan/${u.permanentId}`).once('value')).val();if(iGB)throw new Error('あなたはこの掲示板から追放されています。');const s=await db.ref(`threads/${id}/postCounter`).once('value');if(s.val()>=POST_LIMIT)throw new Error(`このスレッドは${POST_LIMIT}レスの上限に達しました。`);const cU=getUser();const nN=document.getElementById('replyName').value.trim();const iS=nN.toLowerCase()==='sage';const fN=iS?cU.name:(nN||cU.name);if(fN&&fN!==cU.name){setUserName(fN);}const t=document.getElementById('replyText').value.trim();if(containsNGWord(t)||containsNGWord(fN))throw new Error('不適切な単語が含まれています。');const f=document.getElementById('replyImage').files[0];if(!t&&!f)throw new Error('本文か画像が必要です');const n=(await db.ref(`threads/${id}/banned/${u.permanentId}`).once('value')).val();if(n)throw new Error('あなたはこのスレッドでアク禁されています。');const i=f?await readFileAsDataURL(f):null;const nPR=db.ref(`threads/${id}/posts`).push();const nPK=nPR.key;const pD={id:nPK,author:u,text:t,img:i,createdAt:Date.now()};const upd={};upd[`threads/${id}/posts/${nPK}`]=pD;upd[`threads/${id}/postCounter`]=firebase.database.ServerValue.increment(1);if(!iS){upd[`threads/${id}/lastUpdatedAt`]=firebase.database.ServerValue.TIMESTAMP;}upd[`userLevels/${u.permanentId}/exp`]=firebase.database.ServerValue.increment(1);await db.ref().update(upd);document.getElementById('replyText').value='';document.getElementById('replyImage').value='';}catch(e){alert('投稿エラー: '+e.message);}finally{b.disabled=false;}
  }
  
  function containsNGWord(t){const l=t.toLowerCase();return NG_WORDS.some(w=>l.includes(w.toLowerCase()));}
  function readFileAsDataURL(f){if(!f.type.startsWith('image/'))throw new Error('画像ファイルを選択してください');if(f.size>MAX_IMAGE_BYTES)throw new Error(`画像サイズは${MAX_IMAGE_BYTES/1024/1024}MB以下にしてください`);return new Promise((s,j)=>{const r=new FileReader();r.onload=()=>s(r.result);r.onerror=j;r.readAsDataURL(f);});}

  function setupVoteModal(textareaId){const oB=document.getElementById('createVoteBtn');if(!oB)return;const m=document.getElementById('voteModal'),cM=document.getElementById('closeVoteModalBtn'),aO=document.getElementById('addVoteOptionBtn'),iB=document.getElementById('insertVoteBtn'),con=document.getElementById('voteOptionsContainer');oB.onclick=()=>{m.style.display='flex';};cM.onclick=()=>{m.style.display='none';};m.onclick=(e)=>{if(e.target===e.currentTarget)m.style.display='none';};aO.onclick=()=>{const i=document.createElement('input');i.type='text';i.className='vote-option-input';i.placeholder=`選択肢${con.children.length+1}`;i.style.marginBottom='8px';con.appendChild(i);};iB.onclick=()=>{const opts=Array.from(con.getElementsByClassName('vote-option-input')).map(i=>i.value.trim()).filter(v=>v!=='');if(opts.length<2){alert('選択肢は2つ以上入力してください。');return;}const tag=`[vote:${opts.join(',')}]`;const ta=document.getElementById(textareaId);ta.value+=`\n${tag}\n`;m.style.display='none';};}
  window.quote=(n)=>{const e=document.getElementById('replyText');if(e){e.value+=`>>${n} `;e.focus();}};
  window.react=(t,p,reac)=>{const r=db.ref(`threads/${t}/posts/${p}/reactions`),u=getUser().permanentId;r.transaction(c=>{if(!c)c={};c[u]=c[u]===reac?null:reac;return c;});};
  window.castVote=(t,p,v,o)=>{const r=db.ref(`threads/${t}/posts/${p}/votes/${v}`),u=getUser().permanentId;r.transaction(c=>{if(!c)c={};c[u]=o;return c;});};
  window.toggleBan=(t,a,n)=>{window.closeUserProfile();const r=db.ref(`threads/${t}/banned/${a}`);r.once('value',s=>{if(s.exists()){if(confirm(`${n}のこのスレでのアク禁を解除しますか？`))r.remove();}else{if(confirm(`${n}をこのスレッドでアク禁にしますか？`))r.set(true);}});};
  window.toggleGlobalBan=(pId,n)=>{window.closeUserProfile();const bR=db.ref(`globalBan/${pId}`);bR.once('value',s=>{if(s.exists()){if(confirm(`${n}を掲示板から追放解除しますか？`))bR.remove();}else{if(confirm(`本当に${n}を掲示板から永久追放しますか？`))bR.set(true);}});};
  window.editPost=async(t,p)=>{const r=db.ref(`threads/${t}/posts/${p}`),o=(await r.once('value')).val();if(o.author.permanentId!==getUser().permanentId)return alert('自分の投稿しか編集できません');const n=prompt('編集内容を入力',o.text);if(n!==null&&!containsNGWord(n)){r.update({text:n});}else if(n&&containsNGWord(n)){alert('不適切な単語が含まれています。')}};
  window.deleteThread=(tId)=>{if(confirm('本当にこのスレッドを削除しますか？\nこの操作は元に戻すことができません。')){db.ref('threads/'+tId).remove().then(()=>{removeFromHistory(tId);goHome();}).catch(e=>{alert('スレッドの削除に失敗しました。');});}};
  window.deletePost=(t,p)=>{if(confirm('この投稿を削除しますか？')){const u={};u[`threads/${t}/posts/${p}/text`]='';u[`threads/${t}/posts/${p}/img`]=null;u[`threads/${t}/posts/${p}/deleted`]=true;db.ref().update(u);}};
  
  window.showUserProfile=async(name, userPermanentId, isOpAdm)=>{
    const modal = document.getElementById('profileModal'), nameEl = document.getElementById('profileName'), idEl = document.getElementById('profileId'), postsListEl = document.getElementById('profilePostsList'), controlsEl = document.getElementById('profileControls');
    nameEl.textContent = name; idEl.textContent = `Permanent ID: ${userPermanentId}`; postsListEl.innerHTML = '投稿を読み込み中...'; controlsEl.innerHTML = '';
    const currentUser = getUser();
    if((isOpAdm || ADMIN_IDS.includes(currentUser.permanentId)) && currentUser.permanentId !== userPermanentId) {
      const currentThreadId = location.hash.startsWith('#thread-') ? location.hash.replace('#thread-','') : null;
      if (currentThreadId) {
        const threadData = (await db.ref(`threads/${currentThreadId}`).once('value')).val();
        if (threadData) {
          const isThreadOp = threadData.op.permanentId === currentUser.permanentId;
          if(isThreadOp || ADMIN_IDS.includes(currentUser.permanentId)) {
            const isBanned = threadData.banned && threadData.banned[userPermanentId];
            controlsEl.innerHTML += `<button class="btn small warn" onclick="window.toggleBan('${currentThreadId}', '${userPermanentId}', '${escapeHTML(name).replace(/'/g, "\\'")}')">${isBanned ? 'このスレのアク禁解除' : 'このスレでアク禁'}</button>`;
          }
        }
      }
      if(ADMIN_IDS.includes(currentUser.permanentId)) {
        const isGloballyBanned = (await db.ref(`globalBan/${userPermanentId}`).once('value')).val();
        controlsEl.innerHTML += `<button class="btn small warn" onclick="window.toggleGlobalBan('${userPermanentId}', '${escapeHTML(name).replace(/'/g, "\\'")}')">${isGloballyBanned ? '永久追放を解除' : '永久追放'}</button>`;
      }
    }
    modal.style.display = 'flex';
    try {
      const s = await db.ref('threads').once('value');
      const allThreadsData = s.val() || {}; 
      const userPosts = [];
      for (const threadId in allThreadsData) {
        const thread = allThreadsData[threadId];
        if (thread.posts) {
          for (const postId in thread.posts) {
            const post = thread.posts[postId];
            if (post.author && post.author.permanentId === userPermanentId) {
              userPosts.push({ thread: thread, post: post });
            }
          }
        }
      }
      if (userPosts.length === 0) { postsListEl.innerHTML = '<div class="small-muted">このユーザーの投稿はありません。</div>'; }
      else { postsListEl.innerHTML = userPosts.sort((a,b)=>b.post.createdAt-a.post.createdAt).map(item=>`<div class="profile-post-item" style="border-bottom: 1px solid var(--border-color); padding: 8px 0;"><div class="small-muted">スレ: <a href="#thread-${item.thread.id}" onclick="window.closeUserProfile()">${escapeHTML(item.thread.title)}</a></div><div style="margin: 4px 0;">${item.post.deleted?'[削除されました]':renderContent(item.post.text.substring(0,100))}${!item.post.deleted&&item.post.text.length>100?'...':''}</div><button class="btn small" onclick="window.goToPost('${item.thread.id}','${item.post.id}')">投稿に飛ぶ</button></div>`).join(''); }
    } catch(e) {
      postsListEl.innerHTML = '<div class="banned-note">投稿の読み込みに失敗しました。</div>'; console.error(e);
    }
  };
  
  window.closeUserProfile=()=>{document.getElementById('profileModal').style.display='none';};
  window.goToPost=(t,p)=>{window.closeUserProfile();location.hash='thread-'+t;setTimeout(()=>{db.ref(`threads/${t}/posts`).orderByChild('createdAt').once('value',s=>{const posts=s.val()||{};const pIdx=Object.keys(posts).findIndex(k=>k===p);if(pIdx!==-1){const tEId=`post-${pIdx+1}`;const pE=document.getElementById(tEId);if(pE){pE.scrollIntoView({behavior:'smooth',block:'center'});pE.style.transition='background-color 0.5s';pE.style.backgroundColor='rgba(21,101,192,0.1)';setTimeout(()=>{pE.style.backgroundColor='';},2000);}}});},500);};
  window.openLightbox=(src)=>{const l=document.getElementById('imageLightbox');document.getElementById('lightboxImage').src=src;l.style.display='flex';};
  window.closeLightbox=()=>{document.getElementById('imageLightbox').style.display='none';};
  
  function applyTheme(t){const b=document.getElementById('themeToggleBtn');if(t==='dark'){document.body.classList.add('dark-mode');if(b)b.textContent='☀️';}else{document.body.classList.remove('dark-mode');if(b)b.textContent='🌙';}}

  function renderApp(){cleanupListeners();refreshHeader();const h=location.hash||'#';if(h.startsWith('#thread-')){renderThread(h.replace('#thread-',''));}else if(h==='#history'){renderHistoryPage();}else{renderHome();}}
  
  document.getElementById('homeBtn').onclick=goHome;
  document.getElementById('historyBtn').onclick=()=>location.hash='history';
  document.getElementById('refreshBtn').onclick=()=>location.reload();
  document.getElementById('changeNameBtn').onclick=()=>{const n=prompt('新しい表示名を入力してください',getUser().name);if(n!==null&&n.trim()!==''&&!containsNGWord(n.trim()))setUserName(n.trim());else if(n&&containsNGWord(n.trim()))alert('不適切な単語が含まれています。');};
  document.getElementById('themeToggleBtn').onclick=()=>{const cT=localStorage.getItem(THEME_KEY)||'light';const nT=cT==='light'?'dark':'light';localStorage.setItem(THEME_KEY,nT);applyTheme(nT);};
  document.getElementById('closeProfileBtn').onclick=window.closeUserProfile;
  document.getElementById('profileModal').onclick=(e)=>{if(e.target===e.currentTarget)window.closeUserProfile();};
  document.getElementById('imageLightbox').onclick=window.closeLightbox;

  applyTheme(localStorage.getItem(THEME_KEY)||'light');
  renderApp();
}
</script>
</body>
</html>