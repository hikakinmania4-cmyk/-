<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🥺ぷゆゆな集会場🥺</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  :root{--primary:#1565c0;--accent:#0288d1;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--danger:#ef4444;--text-main:#111827;--text-muted:#6b7280;--border-color:#e5e7eb;}
  .dark-mode{--primary:#60a5fa;--accent:#38bdf8;--bg:#111827;--card:#1f2937;--muted:#9ca3af;--text-main:#f9fafb;--text-muted:#9ca3af;--border-color:#374151;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:var(--bg);margin:0;padding:0;color:var(--text-main);transition:background-color .3s,color .3s;}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  header h1{margin:0;font-size:18px;flex-grow:1;word-break:break-all;}
  header .controls{display:flex;gap:8px;align-items:center;}
  header .userbox{font-size:13px; margin-left: auto; text-align:right;}
  header button{background:rgba(255,255,255,0.14);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  header button:hover{background:rgba(255,255,255,0.22)}
  .wrap{max-width:1000px;margin:16px auto;padding:12px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(2,6,23,0.06);margin-bottom:12px;border:1px solid var(--border-color); transition: background-color .3s, border-color .3s;}
  .card h2{margin:0 0 8px 0;font-size:16px;color:var(--primary);word-break:break-all;}
  .thread-header{display:grid;grid-template-columns:1fr auto;gap:8px;}
  .thread-header-main{grid-column:1;min-width:0;}
  .thread-header-meta{grid-column:2;text-align:right;flex-shrink:0;}
  input[type="text"],textarea,select{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;background:var(--card);color:var(--text-main);}
  textarea{min-height:80px;resize:vertical}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background-color 0.2s;}
  .btn:disabled{background:var(--muted);cursor:not-allowed;}
  .btn.warn{background:var(--danger)}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
  .btn.liked{background:#e11d48;color:white;}
  .search-box{display:flex;gap:8px;margin-bottom:12px;}
  .thread-item, .history-item{padding:10px;border-radius:8px;border:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;gap:12px; margin-bottom: 8px;}
  .thread-link{font-weight:600;color:var(--primary);text-decoration:none; display:block;}
  .thread-info{flex-grow:1; display:flex; align-items:center; gap: 8px; min-width:0;}
  .thread-title-wrapper{min-width:0;}
  .thread-preview-img{width:60px;height:60px;object-fit:cover;border-radius:6px;margin-left:12px;flex-shrink:0;}
  .meta{font-size:13px;color:var(--text-muted)}
  .post{padding:10px;border-top:1px solid var(--border-color);margin-top:8px;}
  #postsContainer > .post:first-child{margin-top:0;}
  .post .meta{font-size:12px;color:var(--text-muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-bottom: 8px;}
  .post .meta .no{color:var(--accent);cursor:pointer;font-weight:700}
  .post .meta .post-author{font-weight:bold;cursor:pointer; color: var(--text-main);}
  .post .body{white-space:pre-wrap;word-break:break-word}
  .post .body a{color:var(--primary);}
  .post img{max-width:280px;height:auto;border-radius:6px;margin-top:8px;display:block;cursor:pointer}
  .controls{margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .badge-op{background:var(--primary);color:white;padding:3px 6px;border-radius:999px;font-size:12px}
  .badge-new{background:var(--danger);color:white;padding:3px 6px;border-radius:999px;font-size:10px;font-weight:bold;}
  .banned-note, .deleted-note{color:var(--danger);font-weight:700;margin-top:8px;}
  .small-muted{font-size:12px;color:var(--text-muted)}
  .modal-overlay,.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-content{background:var(--bg);border-radius:10px;width:90%;max-width:600px;max-height:80%;display:flex;flex-direction:column;border:1px solid var(--border-color);}
  .modal-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;}
  .modal-header h2{font-size:18px;color:var(--primary);margin:0;}
  .modal-close-btn,.lightbox-close-btn{font-size:28px;background:none;border:none;cursor:pointer;color:white;position:absolute;top:10px;right:15px;}
  .modal-close-btn{color:var(--text-muted);position:static;}
  .modal-body{padding:16px;overflow-y:auto;}
  #profileId{color:var(--text-muted);font-size:13px;margin:0 0 12px 0;word-break:break-all;}
  .lightbox-content img{max-width:90vw;max-height:90vh;display:block;}
  @media(max-width:680px){header{justify-content:center;}header .userbox{width:100%;text-align:center;margin:4px 0;}}
</style>
</head>
<body>
  <header>
    <h1>🥺ぷゆゆな集会場🥺</h1>
    <div class="userbox"><span id="userDisplay"></span> <button id="changeNameBtn" class="small">名前変更</button></div>
    <div class="controls"><button id="homeBtn">🏠 ホーム</button><button id="historyBtn">📜 履歴</button><button id="themeToggleBtn">🌙</button><button id="refreshBtn">🔄 更新</button></div>
  </header>
  <div class="wrap" id="app"></div>
  <div id="profileModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="profileName"></h2><button id="closeProfileBtn" class="modal-close-btn">&times;</button></div><div class="modal-body"><p id="profileId"></p><h3>この人の投稿</h3><div id="profilePostsList"></div></div></div></div>
  <div id="imageLightbox" class="lightbox-overlay"><div class="lightbox-content"><img id="lightboxImage" src=""><button id="lightboxClose" class="lightbox-close-btn">&times;</button></div></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDS3Tlr9Oc4z5Kz2Zg72p9VRayPSAbmwTw",
  authDomain: "config-f5509.firebaseapp.com",
  databaseURL: "https://config-f5509-default-rtdb.firebaseio.com",
  projectId: "config-f5509",
  storageBucket: "config-f5509.appspot.com",
  messagingSenderId: "513023904601",
  appId: "1:513023904601:web:1846aa87aec5de306e1a48",
  measurementId: "G-KT2LZC2EED"
};
const NG_WORDS = ['바보', '멍청이', '죽어'];
document.addEventListener('DOMContentLoaded', () => { main(); });
function main() {
  if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
    document.getElementById('app').innerHTML = `<div class="card"><h2>🚨 設定が必要です！</h2><p>HTMLファイル内の <code>firebaseConfig</code> が未設定です。</p></div>`; return;
  }
  try { firebase.initializeApp(firebaseConfig); } catch (e) { alert("Firebaseの初期化に失敗しました。"); return; }
  const db = firebase.database();
  let activeDataListener = null, activeViewersListener = null, myConnectionRef = null, allThreads = [];
  function cleanupListeners() {
    if(activeDataListener){ activeDataListener.ref.off('value', activeDataListener.callback); activeDataListener = null; }
    if(activeViewersListener){ activeViewersListener.ref.off('value', activeViewersListener.callback); activeViewersListener = null; }
    if(myConnectionRef){ myConnectionRef.remove(); myConnectionRef = null; }
  }
  const DAILY_USER_COOKIE = 'puyuyun_daily_user_v1', USERNAME_COOKIE = 'puyuyun_username_v1', MAX_IMAGE_BYTES = 10 * 1024 * 1024, POST_LIMIT = 1000, HISTORY_KEY = 'puyuyun_history_v1', THEME_KEY = 'puyuyun_theme';
  function uid(l=8){return Math.random().toString(36).slice(2,2+l).toUpperCase();}
  function setCookie(n,v,d=365){const e=new Date();e.setTime(e.getTime()+(d*24*60*60*1000));document.cookie=`${n}=${encodeURIComponent(v)};expires=${e.toUTCString()};path=/;SameSite=Lax`;}
  function getCookie(n){const kv=document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(n+'='));return kv?decodeURIComponent(kv.split('=')[1]):null;}
  function escapeHTML(s){if(s==null)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
  function renderContent(s) {
    const escaped = escapeHTML(s);
    const withAnkas = escaped.replace(/&gt;&gt;(\d+)/g, '<a href="#" data-link="$1">&gt;&gt;$1</a>');
    const urlRegex = /(https?:\/\/[^\s<>"'()]+)/g;
    const withUrls = withAnkas.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    return withUrls.replace(/\n/g, '<br>');
  }
  function ensureUser() {
    const todayStr = new Date().toISOString().slice(0, 10);
    let dailyUser = {};
    try { dailyUser = JSON.parse(getCookie(DAILY_USER_COOKIE) || '{}'); } catch (e) {}
    if (dailyUser.date !== todayStr || !dailyUser.id) {
      dailyUser = { id: uid(), date: todayStr };
      setCookie(DAILY_USER_COOKIE, JSON.stringify(dailyUser), 1);
    }
    let username = getCookie(USERNAME_COOKIE) || '名無し' + Math.floor(Math.random()*900+100);
    return { id: dailyUser.id, name: username };
  }
  function setUserName(n){setCookie(USERNAME_COOKIE, n, 365);refreshHeader();}
  function getUser(){return ensureUser();}
  function refreshHeader(){document.getElementById('userDisplay').textContent=`あなた: ${getUser().name}`;}
  function loadHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[];}catch(e){return[];}}
  function saveHistory(h){localStorage.setItem(HISTORY_KEY,JSON.stringify(h));}
  function addToHistory(id,title,img,lastUpdatedAt){let h=loadHistory();h=h.filter(i=>i.id!==id);h.unshift({id,title,img,lastUpdatedAt,visitedAt:Date.now()});if(h.length>50)h.pop();saveHistory(h);}
  function goHome(){location.hash='';}
  window.addEventListener('hashchange', renderApp);

  function displayThreads(threadsToDisplay) {
    const c = document.getElementById('threadListContainer'); if(!c) return;
    const history = loadHistory();
    if(threadsToDisplay.length===0){c.innerHTML=`<div class="small-muted">該当するスレッドがありません</div>`;}
    else{c.innerHTML='';threadsToDisplay.forEach(t=>{
      const firstPost = t.posts ? Object.values(t.posts).sort((a,b)=>a.createdAt-b.createdAt)[0] : null;
      const imgHtml = firstPost && firstPost.img ? `<img src="${firstPost.img}" class="thread-preview-img" alt="preview">` : '';
      const historyItem = history.find(h => h.id === t.id);
      const newBadge = historyItem && t.lastUpdatedAt > historyItem.visitedAt ? `<span class="badge-new">New!</span>` : '';
      const i=document.createElement('div');i.className='thread-item';
      i.innerHTML=`<div class="thread-info"><div class="thread-title-wrapper"><a class="thread-link" href="#thread-${t.id}">${escapeHTML(t.title)}</a></div>${newBadge}</div><div class="meta" style="flex-shrink:0;">(${(t.posts?Object.keys(t.posts).length:0)}レス)</div>${imgHtml}`;
      c.appendChild(i);
    });}
  }

  function renderHome() {
    document.getElementById('app').innerHTML = `<div class="card"><h2>新しいスレッドを作成</h2><input id="newTitle" type="text" placeholder="タイトル" style="margin-bottom:8px;"><input id="newName" type="text" placeholder="名前（任意）" value="${escapeHTML(getUser().name)}" style="margin-bottom:8px;"><textarea id="newText" placeholder="本文 (必須)"></textarea><div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;"><input id="newImage" type="file" accept="image/*"><button class="btn" id="createThreadBtn">スレ作成</button></div></div><div class="card"><h2>スレッド一覧</h2><div class="search-box"><input type="text" id="searchInput" placeholder="スレッドタイトルを検索"><button id="searchBtn" class="btn small">検索</button><button id="clearSearchBtn" class="btn small">クリア</button></div><div id="threadListContainer">読み込み中...</div></div>`;
    const ref = db.ref('threads').orderByChild('lastUpdatedAt');
    const cb = ref.on('value', s => {
      allThreads = Object.values(s.val()||{}).sort((a,b)=>b.lastUpdatedAt-a.lastUpdatedAt);
      displayThreads(allThreads);
    }, e => { console.error(e); });
    activeDataListener = { ref, callback: cb };
    document.getElementById('searchBtn').onclick = () => {
      const term = document.getElementById('searchInput').value.toLowerCase();
      if(!term) return;
      const filtered = allThreads.filter(t => t.title.toLowerCase().includes(term));
      displayThreads(filtered);
    };
    document.getElementById('clearSearchBtn').onclick = () => {
      document.getElementById('searchInput').value = '';
      displayThreads(allThreads);
    };
    document.getElementById('searchInput').onkeydown = (e) => { if(e.key === 'Enter') document.getElementById('searchBtn').click(); };
    document.getElementById('createThreadBtn').onclick = async () => {
      const b=document.getElementById('createThreadBtn');b.disabled=true;b.textContent='作成中...';
      try {
        const t=document.getElementById('newTitle').value.trim(),n=document.getElementById('newName').value.trim(),x=document.getElementById('newText').value.trim(),f=document.getElementById('newImage').files[0];
        if(!t||!x)throw new Error('タイトルと本文は必須です');
        if(containsNGWord(t) || containsNGWord(x) || containsNGWord(n)) throw new Error('不適切な単語が含まれています。');
        const u=getUser(); if(n&&n!==u.name){ setUserName(n); }
        const i=f?await readFileAsDataURL(f):null,r=db.ref('threads').push(),d=r.key,w=Date.now();
        const firstPostKey = r.key;
        await r.set({id:d,title:t,createdAt:w,lastUpdatedAt:w,op:getUser(),posts:{[firstPostKey]:{id:firstPostKey,author:getUser(),text:x,img:i,createdAt:w}},postCounter:1});
        location.hash='thread-'+d;
      } catch (e) { alert('エラー: '+e.message); b.disabled=false; b.textContent='スレ作成'; }
    };
  }
  
  function renderHistoryPage() {
    const history = loadHistory();
    let content = '<h2>📜 閲覧履歴</h2>';
    if(history.length === 0) { content += '<div class="small-muted">まだ閲覧履歴がありません。</div>'; }
    else { history.forEach(item => {
      const imgHtml = item.img ? `<img src="${item.img}" class="thread-preview-img" alt="preview">` : '';
      const newBadge = item.lastUpdatedAt > item.visitedAt ? `<span class="badge-new">New!</span>` : '';
      content += `<div class="history-item"><div class="thread-info"><a class="thread-link" href="#thread-${item.id}">${escapeHTML(item.title)}</a>${newBadge}</div><div style="text-align:right;"><div class="small-muted">${new Date(item.visitedAt).toLocaleString()}</div></div>${imgHtml}</div>`;
    }); }
    document.getElementById('app').innerHTML = `<div class="card">${content}</div>`;
  }

  function renderThread(id) {
    document.getElementById('app').innerHTML=`<div class="card">読み込み中...</div>`;
    const ref = db.ref('threads/'+id);
    const cb = ref.on('value', s => {
      if(!document.getElementById('app')) return;
      const t=s.val(); if(!t){goHome(); return;}
      const p=Object.values(t.posts||{}).sort((a,b)=>a.createdAt-b.createdAt);
      const opPost = p[0] || {};
      addToHistory(t.id, t.title, opPost.img || null, t.lastUpdatedAt);
      const u=getUser(),o=t.op&&t.op.id===u.id;
      const postCount = p.length;
      let replyFormHtml = (postCount>=POST_LIMIT)?`<div class="banned-note" style="text-align:center;padding:10px;">このスレッドは${POST_LIMIT}レスに達しました。</div>`:`<h4>レス投稿</h4><input id="replyName" type="text" placeholder="名前" value="${escapeHTML(u.name)}" style="margin-bottom:8px;"><small class="small-muted" style="display:block;margin-top:-6px;margin-bottom:8px;">名前欄に sage と入力するとスレッドがトップに上がらなくなります。</small><textarea id="replyText" placeholder="本文"></textarea><div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;"><input id="replyImage" type="file" accept="image/*"><button class="btn" id="replyBtn">投稿</button></div>`;
      let postsHtml = '';
      p.forEach((post, index) => {
        const b=t.banned&&t.banned[post.author.id], l=post.likers||{}, k=Object.keys(l).length, h=l[u.id];
        let authorHtml = `<b class="post-author" onclick="window.showUserProfile('${escapeHTML(post.author.name).replace(/'/g, "\\'")}', '${post.author.id}')">${escapeHTML(post.author.name)}</b>`;
        if(post.author.id === t.op.id) authorHtml += ` <span class="badge-op">スレ主</span>`;
        let controlsHtml = `<button class="btn small ${h?'liked':''}" onclick="window.like('${id}','${post.id}')">${h?'❤️':'👍'} ${k}</button>`;
        if(u.id === post.author.id || o) controlsHtml += ` <button class="btn small warn" onclick="window.deletePost('${id}','${post.id}')">削除</button>`;
        if(u.id === post.author.id) controlsHtml += ` <button class="btn small" onclick="window.editPost('${id}','${post.id}')">編集</button>`;
        if(o && u.id !== post.author.id) controlsHtml += ` <button class="btn small warn" onclick="window.toggleBan('${id}','${post.author.id}','${escapeHTML(post.author.name).replace(/'/g, "\\'")}')">${b?'解除':'アク禁'}</button>`;
        const postBody = post.deleted ? `<div class="deleted-note">[削除されました]</div>` : `<div class="body">${renderContent(post.text)}</div>${post.img?`<img src="${post.img}" onclick="window.openLightbox(this.src)">`:''}`;
        postsHtml += `<div class="post" id="post-${index + 1}"><div class="meta"><span class="no" onclick="window.quote(${index + 1})">No.${index + 1}</span>${authorHtml}<span class="small-muted" style="margin-left:auto">${new Date(post.createdAt).toLocaleString()}</span></div>${b?`<div class="banned-note">このユーザーはアク禁されています</div>`: `${postBody}<div class="controls">${controlsHtml}</div>`}</div>`;
      });
      document.getElementById('app').innerHTML = `<div class="card"><div class="thread-header"><div class="thread-header-main"><h2>${escapeHTML(t.title)}</h2></div><div class="thread-header-meta">${o ? `<button class="btn small warn" onclick="window.deleteThread('${id}')">スレを削除</button>` : ''}<div class="small-muted">作成: ${new Date(t.createdAt).toLocaleString()}</div><div class="small-muted" style="margin-top:4px;">閲覧中: <span id="viewer-count">...</span>人</div></div></div></div><div class="card" id="postsContainer">${postsHtml}</div><div class="card">${replyFormHtml}</div>`;
      document.querySelectorAll('a[data-link]').forEach(a=>{a.onclick=e=>{e.preventDefault();document.getElementById(`post-${a.dataset.link}`).scrollIntoView({behavior:'smooth',block:'center'});};});
      if(postCount<POST_LIMIT){document.getElementById('replyBtn').onclick=()=>postReply(id);}
    }, e=>{console.error(e);});
    activeDataListener={ref,callback:cb};const vRef=db.ref('viewers/'+id);myConnectionRef=vRef.push(true);myConnectionRef.onDisconnect().remove();const vCb=vRef.on('value',s=>{const e=document.getElementById('viewer-count');if(e)e.textContent=s.numChildren();});activeViewersListener={ref:vRef,callback:vCb};
  }

  async function postReply(id) {
    const b=document.getElementById('replyBtn'); b.disabled=true;
    try {
      const snapshot = await db.ref(`threads/${id}/postCounter`).once('value');
      if (snapshot.val() >= POST_LIMIT) throw new Error(`このスレッドは${POST_LIMIT}レスの上限に達しました。`);
      const currentUser = getUser(); const newName = document.getElementById('replyName').value.trim();
      const isSage = newName.toLowerCase() === 'sage';
      const finalName = isSage ? currentUser.name : (newName || currentUser.name);
      if(finalName && finalName !== currentUser.name) { setUserName(finalName); }
      const t=document.getElementById('replyText').value.trim();
      if(containsNGWord(t) || containsNGWord(finalName)) throw new Error('不適切な単語が含まれています。');
      const f=document.getElementById('replyImage').files[0];
      if(!t && !f)throw new Error('本文か画像が必要です');
      const u=getUser(),n=(await db.ref(`threads/${id}/banned/${u.id}`).once('value')).val();
      if(n)throw new Error('あなたはこのスレッドでアク禁されています。');
      const i=f?await readFileAsDataURL(f):null;
      const newPostRef = db.ref(`threads/${id}/posts`).push();
      const newPostKey = newPostRef.key;
      const postData = {id: newPostKey, author: {id: u.id, name: finalName}, text:t, img:i, createdAt:Date.now()};
      const updates = {};
      updates[`threads/${id}/posts/${newPostKey}`] = postData;
      updates[`threads/${id}/postCounter`] = firebase.database.ServerValue.increment(1);
      if(!isSage) { updates[`threads/${id}/lastUpdatedAt`] = firebase.database.ServerValue.TIMESTAMP; }
      await db.ref().update(updates);
      document.getElementById('replyText').value='';document.getElementById('replyImage').value='';
    } catch(e){alert('投稿エラー: '+e.message);} finally{b.disabled=false;}
  }
  
  function containsNGWord(text) { const lowerText = text.toLowerCase(); return NG_WORDS.some(word => lowerText.includes(word.toLowerCase())); }
  function readFileAsDataURL(f){if(!f.type.startsWith('image/'))throw new Error('画像ファイルを選択してください');if(f.size>MAX_IMAGE_BYTES)throw new Error(`画像サイズは${MAX_IMAGE_BYTES/1024/1024}MB以下にしてください`);return new Promise((s,j)=>{const r=new FileReader();r.onload=()=>s(r.result);r.onerror=j;r.readAsDataURL(f);});}

  window.quote=(n)=>{const e=document.getElementById('replyText');if(e){e.value+=`>>${n} `;e.focus();}};
  window.like=(t,p)=>{const r=db.ref(`threads/${t}/posts/${p}/likers`),u=getUser().id;r.transaction(c=>{if(c&&c[u]){c[u]=null;}else{if(!c)c={};c[u]=true;}return c;});};
  window.toggleBan=(t,a,n)=>{const r=db.ref(`threads/${t}/banned/${a}`);r.once('value',s=>{if(s.exists()){if(confirm(`${n}のアク禁を解除しますか？`))r.remove();}else{if(confirm(`${n}をアク禁にしますか？`))r.set(true);}});};
  window.editPost=async(t,p)=>{const r=db.ref(`threads/${t}/posts/${p}`),o=(await r.once('value')).val();if(o.author.id!==getUser().id)return alert('自分の投稿しか編集できません');const n=prompt('編集内容を入力',o.text);if(n!==null&&!containsNGWord(n)){r.update({text:n});}else if(n && containsNGWord(n)){alert('不適切な単語が含まれています。')}};
  window.deleteThread = (threadId) => { if (confirm('本当にこのスレッドを削除しますか？\nこの操作は元に戻すことができません。')) { db.ref('threads/' + threadId).remove().then(()=>{goHome();}).catch((e)=>{alert('スレッドの削除に失敗しました。');});}};
  window.deletePost = (threadId, postId) => { if(confirm('この投稿を削除しますか？')){ const updates = {}; updates[`threads/${threadId}/posts/${postId}/text`] = ''; updates[`threads/${threadId}/posts/${postId}/img`] = null; updates[`threads/${threadId}/posts/${postId}/deleted`] = true; db.ref().update(updates); }};
  window.showUserProfile = async (name, id) => {
    const modal = document.getElementById('profileModal'); const nameEl = document.getElementById('profileName'); const idEl = document.getElementById('profileId'); const postsListEl = document.getElementById('profilePostsList');
    nameEl.textContent = name; idEl.textContent = `ID: ${id}`; postsListEl.innerHTML = '投稿を読み込み中...'; modal.style.display = 'flex';
    try {
      const snapshot = await db.ref('threads').once('value'); const allThreads = snapshot.val() || {}; const userPosts = [];
      for (const threadId in allThreads) { const thread = allThreads[threadId]; if (thread.posts) { for (const postId in thread.posts) { const post = thread.posts[postId]; if (post.author && post.author.id === id) { userPosts.push({ thread, post }); }}}}
      if (userPosts.length === 0) { postsListEl.innerHTML = '<div class="small-muted">このユーザーの投稿はありません。</div>'; }
      else { postsListEl.innerHTML = userPosts.sort((a,b) => b.post.createdAt - a.post.createdAt).map(item => `<div class="profile-post-item"><div class="title">スレ: ${escapeHTML(item.thread.title)}</div><div class="body">${item.post.deleted ? '[削除されました]' : renderContent(item.post.text.substring(0, 100))}${!item.post.deleted && item.post.text.length > 100 ? '...' : ''}</div><button class="btn small" onclick="window.goToPost('${item.thread.id}', '${item.post.id}')">投稿に飛ぶ</button></div>`).join(''); }
    } catch (e) { postsListEl.innerHTML = '<div class="banned-note">投稿の読み込みに失敗しました。</div>'; console.error(e); }
  };
  window.closeUserProfile = () => { document.getElementById('profileModal').style.display = 'none'; };
  window.goToPost = (threadId, postId) => {
    window.closeUserProfile(); location.hash = 'thread-' + threadId;
    setTimeout(() => {
        db.ref(`threads/${threadId}/posts`).orderByChild('createdAt').once('value', snapshot => {
            const posts = snapshot.val() || {};
            const postIndex = Object.keys(posts).findIndex(key => key === postId);
            if (postIndex !== -1) {
                const targetElId = `post-${postIndex + 1}`;
                const postEl = document.getElementById(targetElId);
                if (postEl) { postEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); postEl.style.transition = 'background-color 0.5s'; postEl.style.backgroundColor = 'rgba(21, 101, 192, 0.1)'; setTimeout(() => { postEl.style.backgroundColor = ''; }, 2000); }
            }
        });
    }, 500);
  };
  window.openLightbox = (src) => { const lb = document.getElementById('imageLightbox'); document.getElementById('lightboxImage').src = src; lb.style.display = 'flex'; };
  window.closeLightbox = () => { document.getElementById('imageLightbox').style.display = 'none'; };
  
  function applyTheme(theme) {
    const btn = document.getElementById('themeToggleBtn');
    if (theme === 'dark') { document.body.classList.add('dark-mode'); if(btn) btn.textContent = '☀️'; }
    else { document.body.classList.remove('dark-mode'); if(btn) btn.textContent = '🌙'; }
  }

  function renderApp(){
    cleanupListeners(); refreshHeader(); const h=location.hash||'#';
    if(h.startsWith('#thread-')){renderThread(h.replace('#thread-',''));}
    else if(h === '#history'){renderHistoryPage();}
    else{renderHome();}
  }
  
  document.getElementById('homeBtn').onclick = goHome;
  document.getElementById('historyBtn').onclick = () => location.hash = 'history';
  document.getElementById('refreshBtn').onclick = () => location.reload();
  document.getElementById('changeNameBtn').onclick = () => { const n = prompt('新しい表示名を入力してください', getUser().name); if(n !== null && n.trim() !== '' && !containsNGWord(n.trim())) setUserName(n.trim()); else if(n && containsNGWord(n.trim())) alert('不適切な単語が含まれています。'); };
  document.getElementById('themeToggleBtn').onclick = () => { const currentTheme = localStorage.getItem(THEME_KEY) || 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); };
  document.getElementById('closeProfileBtn').onclick = window.closeUserProfile;
  document.getElementById('profileModal').onclick = (e) => { if (e.target === e.currentTarget) window.closeUserProfile(); };
  document.getElementById('imageLightbox').onclick = window.closeLightbox;

  applyTheme(localStorage.getItem(THEME_KEY) || 'light');
  renderApp();
}
</script>
</body>
</html>